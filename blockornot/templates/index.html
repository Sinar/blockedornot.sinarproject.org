<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network Accessibiliy & Content Checker(NACC)</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/nacc.css">

</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">NACC</a>
        </div>

    </div>
    <div class="jumbotron">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2">
                    <div id="error_msg"></div>
                    <form class="form-inline" id="queryForm">
                        <div class="form-group">
                            <input type="text" class="form-control" id="targetURL" placeholder="www.sarawakreport.org"/>
                        </div>
                        <button type="button" class="btn btn-default" id="callCheck">Check</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% for isp in isps %}
        <div class="container" id="{{isp}}">
            <h3>{{isp}}</h3>
            {% for location in locations[isp] %}

                <div class="container {{location|replace(' ', '_')}}">
                    <h4>location: {{location}}</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <td>Test</td>
                                <td>Test Result</td>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>

                </div>
            {% endfor %}
        </div>
    {% endfor %}




</body>
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
        // TODO: I think the code here can be consolidated too
        var http_check = io.connect("http://"+document.domain+":"+location.port + "/checkhttp");

        http_check.on('connect', function(){


        });
        http_check.on('http received', function(data){
            var task_id = data["task_id"];
            //what the fuck is this shit
            var current_element = "#"+ data["ISP"] + " ." + data["location"].replace(" ", "_") + " table";
            var task_element = "#" + task_id;
            var task_value_element = task_element + " .value";
            if(!$(task_element).length){
                   var task_row = "<tr id=\""+ task_id +"\"><td>" + data["description"] + "</td><td class=\"value\"></td>";
                    $(current_element + " tbody").append(task_row);

            }
           if(data["status"] == "PENDING"){
               console.log(data["task_id"]);


               $(task_value_element).addClass("bg-warning");
               $(task_value_element).text("Pending");
               http_check.emit("http result",{ "task_id": data["task_id"], ISP: data["ISP"], test_type: data["test_type"], location: data["location"] })
           }
            else if(data["status"] == "SUCCESS"){
               if(data["status_code"] != 200){
                   console.log(data);
                   $(task_value_element).removeClass("bg-warning");
                   $(task_value_element).addClass("bg-danger");
                   $(task_value_element).text("Error status code: "+data["status_code"] + " " + data["reason"]);
               }
               else{
                   console.log(data);
                   $(task_value_element).removeClass("bg-warning");
                   $(task_value_element).addClass("bg-success");
                   $(task_value_element).text("Success! status code: "+data["status_code"] + " " + data["reason"]);
               }
           }
            else{
               $(task_value_element).removeClass("bg-warning");
               $(task_value_element).addClass("bg-danger");
               $(task_value_element).text("Error status code: "+data["status_code"]);
           }
        });
        var dns_check = io.connect("http://"+document.domain+":"+location.port + "/checkdns");
        dns_check.on("connect", function () {


        });
        dns_check.on("dns received", function (data) {
            console.log("DNS CHECK");
            console.log(data);
            var task_id = data["task_id"];
            var current_element = "#"+ data["ISP"] + " ." + data["location"].replace(" ", "_") + " table";
            var task_element = "#" + task_id;
            var task_value_element = task_element + " .value";
            if(!$(task_element).length){
                   var task_row = "<tr id=\""+ task_id +"\"><td>" + data["description"] + "</td><td class=\"value\"></td>";
                    $(current_element + " tbody").append(task_row);

               }
           if(data["status"] == "SUCCESS"){
               if(data["status_code"] == "OK"){

                   $(task_value_element).removeClass("bg-warning");
                   $(task_value_element).addClass("bg-success");
                   $(task_value_element).text(data["status_code"] + " " + data["reason"]);
               }
               else{
                   $(task_value_element).removeClass("bg-warning");
                   $(task_value_element).addClass("bg-danger");
                   $(task_value_element).text(data["status_code"] + " " + data["reason"]);

               }
           }
           else if(data["status"] == "PENDING"){
               console.log(data);

               $(task_value_element).addClass("bg-warning");
               $(task_value_element).text("Pending");
               dns_check.emit("dns result", {
                   location: data["location"],
                   ISP: data["ISP"],
                   task_id: data["task_id"],
                   provider: data["provider"],
                   server: data["server"],
                   test_type: data["test_type"]});
           }
            else{

               $(task_value_element).removeClass("bg-warning");
               $(task_value_element).addClass("bg-danger");
               $(task_value_element).text(data["status_code"] + " " + data["reason"]);
           }
        });

        var http_dpi_check = io.connect("http://"+document.domain+":"+location.port + "/checkdpi");
        http_dpi_check.on('connect', function(){


        });

        http_dpi_check.on("http dpi received", function (data) {
            var task_id = data["task_id"];
            var current_element = "#"+ data["ISP"] + " ." + data["location"].replace(" ", "_") + " table";
            var task_element = "#" + task_id;
            var task_value_element = task_element + " .value";
            if(!$(task_element).length){
                   var task_row = "<tr id=\""+ task_id +"\"><td>" + data["description"] + "</td><td class=\"value\"></td>";
                    $(current_element + " tbody").append(task_row);

            }
            if(data["status"] == "SUCCESS"){
               if(data["status_code"] == "SUCCESS"){

                   $(task_value_element).removeClass("bg-warning");
                   $(task_value_element).addClass("bg-success");
                   $(task_value_element).text(data["status_code"] + " " + data["reason"]);
               }
               else{
                   $(task_value_element).removeClass("bg-warning");
                   $(task_value_element).addClass("bg-danger");
                   $(task_value_element).text(data["status_code"] + " " + data["reason"]);

               }
           }
           else if(data["status"] == "PENDING"){
               console.log(data);

               $(task_value_element).addClass("bg-warning");
               $(task_value_element).text("Pending");
               http_dpi_check.emit("http dpi result", {
                   location: data["location"],
                   ISP: data["ISP"],
                   task_id: data["task_id"],
                   test_type: data["test_type"]});
           }
            else{

               $(task_value_element).removeClass("bg-warning");
               $(task_value_element).addClass("bg-danger");
               $(task_value_element).text(data["status_code"] + " " + data["reason"]);
           }
        });

        $("#callCheck").click(function(){

            console.log($("#targetURL").val());
            $("#error_msg").empty();
            if($("#targetURL").val() != "") {
                $("tbody").empty();
                http_check.emit('check http', {url: $("#targetURL").val()});
                dns_check.emit("check dns", {url: $("#targetURL").val()});
                http_dpi_check.emit("check http dpi", {url: $("#targetURL").val()});
            }
            else{
                $("#error_msg").append("<div class=\"alert alert-danger\" role=\"alert\">Please enter a valid website domain</div>");
            }
        });

    });
</script>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');  ga('create', 'UA-29734766-8', 'auto');
 ga('send', 'pageview');</script>
</html>